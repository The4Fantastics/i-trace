<?xml version="1.0" encoding="UTF-8"?>
<project name="ATL2Metrics" default="main" basedir=".">
<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
	
  <!-- Set paths -->
  <property name='sourcedir' value='Code'/>
  <property name='trafodir'  value='Transformations'/>
  <property name='mmdir'     value='Metamodels'/>
  <property name='targetdir' value='Models'/>	
	
	<target name="main">
	  		<foreach param="file" target="list">
	  			<path>
	  				<fileset dir="${sourcedir}">
	  					<filename name="*.atl" />
	  				</fileset>
	  			</path>
	  		</foreach>
	  	</target>
	<target name="list">
	  	<basename property="name" file="${file}" />
		<antcall target="extract">
				<param name="inputname" value="${name}" />
		</antcall>
	</target>
  


	
  <target name="extract">
  	<property name='inputfile' value='${sourcedir}/${inputname}' />
  	<atl.loadModel modelHandler="EMF" name="ATL" metamodel="%EMF" path="${mmdir}/ATL.ecore"/>
  	
  	<!-- Generate an ATL model from the code -->
    <atl.loadModel modelHandler="EMF" name="ATLtrafo" metamodel="ATL" path="${inputfile}">
      <injector name="ATL"/>
    </atl.loadModel>
    <atl.loadModel metamodel="%EMF" name="Metrics" path="${mmdir}/Metrics.ecore"/>
  	
  	<!-- Perform the metrics extraction transformation -->
  	<atl.launch path="${trafodir}/ATL2Metrics.asm" refining="false">
  	  <inModel name="IN" model="ATLtrafo"/>
  	  <outModel name="OUT" model="out" metamodel="Metrics"/>
  	</atl.launch>

  	<!-- Serialize the result of the transformation -->
  	<atl.saveModel model="out" path="${targetdir}/${inputname}.Metrics" />
  </target>
</project>